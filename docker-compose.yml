# TF2 Classified Dedicated Server
#
# Usage:
#   docker compose up -d                                       # single server (Steam relay, IP hidden)
#   docker compose --profile fastdl up -d                      # with self-hosted FastDL
#   docker compose --profile server2 up -d                     # run additional server
#   make relay                                                 # tunnel through WireGuard relay
#
# Steam Datagram Relay hides your IP by default.
#
# Multiple servers share game volumes (TF2 base + TF2 Classified, ~22GB) so
# they only download once. Each server gets its own configs, logs, and demos.
# Custom maps can be shared (data/maps) or per-server (servers/N/maps).

services:
  tf2classified:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PUID: ${PUID:-1000}
        PGID: ${PGID:-1000}
    container_name: tf2classified
    restart: unless-stopped

    # Host networking avoids Docker NAT overhead and is required for
    # Steam networking relay to function correctly.
    network_mode: host

    env_file:
      - .env

    volumes:
      # Game files persist in named volumes (~20GB, survives rebuilds)
      - tf2-data:/data/tf
      - classified-data:/data/classified

      # Your custom content (bind-mounted, read-only)
      - ./data/cfg:/data/cfg:ro
      - ./data/addons:/data/addons:ro
      - ./data/maps:/data/maps:ro

      # Writable outputs
      - ./data/logs:/data/logs
      - ./data/demos:/data/demos
      - ./data/fastdl:/data/fastdl

    # Give srcds time to disconnect players and save state
    stop_grace_period: 30s

    stdin_open: true
    tty: true

    logging:
      driver: json-file
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILE:-3}"

  # --------------------------------------------------------------------------
  # FastDL web server (optional)
  #
  # Serves custom maps/content over HTTP so players don't suffer the slow
  # in-game transfer.
  #
  # Setup:
  #   1. Drop .bsp files in data/maps/
  #   2. Run: make compress-maps
  #   3. Set FASTDL_URL in .env (e.g. http://your-ip:8080/tf2classified)
  #   4. docker compose --profile fastdl up -d
  #
  # Or use an external CDN (Cloudflare R2, S3, etc.) and just set FASTDL_URL.
  # --------------------------------------------------------------------------
  fastdl:
    image: nginx:alpine
    container_name: tf2c-fastdl
    restart: unless-stopped
    ports:
      - "${FASTDL_PORT:-8080}:80"
    volumes:
      - ./data/fastdl:/usr/share/nginx/html:ro
      - ./nginx/fastdl.conf:/etc/nginx/conf.d/default.conf:ro
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /var/cache/nginx
      - /var/run
      - /var/log/nginx
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    profiles:
      - fastdl

  # --------------------------------------------------------------------------
  # Additional server instances (optional)
  #
  # All servers share game files (~22GB downloads once). Each server has:
  #   - Own config (servers/N/cfg/) or shared (data/cfg/)
  #   - Own addons (servers/N/addons/) or shared (data/addons/)
  #   - Own maps (servers/N/maps/) or shared (data/maps/)
  #   - Own logs (servers/N/logs/) — always per-server
  #   - Own demos (servers/N/demos/) — always per-server
  #
  # Setup:
  #   1. make add-server N=2        (creates dirs + .env.server2)
  #   2. Edit .env.server2          (change name, port, RCON, etc.)
  #   3. docker compose --profile server2 up -d
  #
  # To share maps/addons with the primary server, edit the volumes below
  # to point to ./data/maps and ./data/addons instead of ./servers/N/...
  # --------------------------------------------------------------------------
  tf2classified-2:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PUID: ${PUID:-1000}
        PGID: ${PGID:-1000}
    container_name: tf2classified-2
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env.server2
    volumes:
      # Shared game files (all servers use the same ~22GB install)
      - tf2-data:/data/tf
      - classified-data:/data/classified
      # Per-server content (change to ./data/X to share with primary)
      - ./servers/2/cfg:/data/cfg:ro
      - ./servers/2/addons:/data/addons:ro
      - ./servers/2/maps:/data/maps:ro
      # Per-server outputs (always separate)
      - ./servers/2/logs:/data/logs
      - ./servers/2/demos:/data/demos
    stop_grace_period: 30s
    stdin_open: true
    tty: true
    logging:
      driver: json-file
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILE:-3}"
    profiles:
      - server2

  tf2classified-3:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        PUID: ${PUID:-1000}
        PGID: ${PGID:-1000}
    container_name: tf2classified-3
    restart: unless-stopped
    network_mode: host
    env_file:
      - .env.server3
    volumes:
      # Shared game files (all servers use the same ~22GB install)
      - tf2-data:/data/tf
      - classified-data:/data/classified
      # Per-server content (change to ./data/X to share with primary)
      - ./servers/3/cfg:/data/cfg:ro
      - ./servers/3/addons:/data/addons:ro
      - ./servers/3/maps:/data/maps:ro
      # Per-server outputs (always separate)
      - ./servers/3/logs:/data/logs
      - ./servers/3/demos:/data/demos
    stop_grace_period: 30s
    stdin_open: true
    tty: true
    logging:
      driver: json-file
      options:
        max-size: "${LOG_MAX_SIZE:-10m}"
        max-file: "${LOG_MAX_FILE:-3}"
    profiles:
      - server3

volumes:
  tf2-data:
  classified-data:
