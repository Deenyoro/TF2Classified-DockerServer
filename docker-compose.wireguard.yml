# WireGuard Relay Overlay
#
# Routes ALL game server traffic through a WireGuard tunnel to a remote
# firewall, hiding your home IP. Players connect to the remote firewall's
# public IP; your real IP is never exposed.
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.wireguard.yml up -d
#   (or: make relay)
#
# Setup:
#   1. Generate WireGuard keys:  wg genkey | tee privatekey | wg pubkey > publickey
#   2. Set the WG_* variables in .env
#   3. Configure the remote firewall (see wireguard/remote-firewall.conf.example)
#   4. Set STEAM_NETWORKING=false in .env
#   5. make relay
#
# All game servers join the WireGuard container's network namespace.
# Outbound Steam heartbeats, inbound player traffic â€” everything goes
# through the tunnel. The remote firewall NATs outbound and DNATs game
# ports inbound.

services:
  wireguard:
    build:
      context: ./wireguard
      dockerfile: Dockerfile
    container_name: tf2c-wireguard
    restart: unless-stopped
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - WG_PRIVATE_KEY=${WG_PRIVATE_KEY}
      - WG_ADDRESS=${WG_ADDRESS:-10.0.0.2/24}
      - WG_DNS=${WG_DNS:-1.1.1.1}
      - WG_PEER_PUBLIC_KEY=${WG_PEER_PUBLIC_KEY}
      - WG_ENDPOINT=${WG_ENDPOINT}
      - WG_ALLOWED_IPS=${WG_ALLOWED_IPS:-0.0.0.0/0}
      - WG_PERSISTENT_KEEPALIVE=${WG_PERSISTENT_KEEPALIVE:-25}
      - WG_RERESOLVE_INTERVAL=${WG_RERESOLVE_INTERVAL:-300}
    volumes:
      - /lib/modules:/lib/modules:ro
    logging:
      driver: json-file
      options:
        max-size: "5m"
        max-file: "2"

  # Override game servers: route all traffic through the WireGuard tunnel
  # instead of using host networking directly.
  tf2classified:
    network_mode: service:wireguard
    depends_on:
      - wireguard

  tf2classified-2:
    network_mode: service:wireguard
    depends_on:
      - wireguard

  tf2classified-3:
    network_mode: service:wireguard
    depends_on:
      - wireguard
